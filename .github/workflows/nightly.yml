name: Nightly Sanitized Run

on:
  schedule:
    # Runs every day at 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  run-test:
    uses: ./.github/workflows/test_workflow.yml
    with:
      configuration: '["asan"]' # Ignoring tsan for now '["asan", "tsan"]'
  report-failures:
    runs-on: ubuntu-latest
    needs: run-test
    if: failure()
    steps:
      - name: Download all failure artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: failures-*
          path: ./artifacts
          merge-multiple: true
      - name: Report failures
        run: |
          # Check if any failure files exist
          if ! ls ./artifacts/failures_*.txt 1> /dev/null 2>&1; then
            echo "No failure artifacts found"
            exit 0
          fi

          # Combine all failure files
          find ./artifacts -name 'failures_*.txt' -exec cat {} \; > ./artifacts/all_failures.txt
          scenarios=$(cat ./artifacts/all_failures.txt | tr '\n' ',' | sed 's/,$//')

          echo "Failed scenarios: $scenarios"

          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
                 -H 'Content-Type: application/json' \
                 -d "{\"scenarios\": \"${scenarios}\", \"failed_run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"
          else
            echo "SLACK_WEBHOOK not configured, skipping notification"
          fi
