name: Nightly Sanitized Run

on:
  workflow_dispatch:

jobs:
  run-test:
    uses: ./.github/workflows/test_workflow.yml
    with:
      configuration: '["asan", "tsan"]'
  report-failures:
    runs-on: ubuntu-latest
    needs: run-test
    steps:
      - name: Download failed tests artifact
        uses: actions/download-artifact@v2
        with:
          name: failures
          path: ./artifacts
      - name: Report failures
        run: |
          scenarios=$(cat ./artifacts/failures.txt | tr '\n' ',')
          curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
             -H 'Content-Type: application/json' \
             -d "{'scenarios': '${scenarios}', 'failed_run_url': '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'}"

