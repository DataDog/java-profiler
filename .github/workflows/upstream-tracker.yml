name: Upstream Async-Profiler Change Tracker

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  workflow_dispatch:
    inputs:
      force_report:
        description: 'Generate report even if no changes detected'
        type: boolean
        default: false

permissions:
  contents: read
  issues: write
  id-token: write # Needed for octo-sts token federation

jobs:
  track-upstream:
    runs-on: ubuntu-latest
    steps:
      - uses: DataDog/dd-octo-sts-action@acaa02eee7e3bb0839e4272dacb37b8f3b58ba80 # v1.0.3
        id: octo-sts
        with:
          scope: DataDog/java-profiler
          policy: self.upstream-tracker.manage-variables

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone upstream async-profiler
        id: clone-upstream
        continue-on-error: true
        run: |
          git clone --depth 50 https://github.com/async-profiler/async-profiler.git /tmp/async-profiler
          cd /tmp/async-profiler
          git fetch origin master
          UPSTREAM_HEAD=$(git rev-parse origin/master)
          echo "UPSTREAM_HEAD=${UPSTREAM_HEAD}" >> $GITHUB_ENV
          echo "Upstream HEAD: ${UPSTREAM_HEAD}"

      - name: Handle clone failure
        if: steps.clone-upstream.outcome == 'failure'
        run: |
          echo "::warning::Failed to clone upstream repository. Will retry on next run."
          exit 0

      - name: Get last checked commit
        if: steps.clone-upstream.outcome == 'success'
        id: get-last-commit
        run: |
          # Try to get the last commit from state file
          STATE_FILE=".github/upstream-tracker-state.txt"

          if [ -f "$STATE_FILE" ]; then
            LAST_COMMIT=$(cat "$STATE_FILE" | tr -d '[:space:]')

            # Validate that LAST_COMMIT is a valid commit SHA (40 hex characters)
            if ! echo "$LAST_COMMIT" | grep -qE '^[0-9a-f]{40}$'; then
              echo "Invalid commit SHA in state file: ${LAST_COMMIT}"
              echo "First run detected, using current HEAD as baseline"
              LAST_COMMIT="${UPSTREAM_HEAD}"
            else
              echo "Last checked commit from state file: ${LAST_COMMIT}"
            fi
          else
            echo "No state file found, first run detected"
            echo "Using current HEAD as baseline"
            LAST_COMMIT="${UPSTREAM_HEAD}"
          fi

          echo "last_commit=${LAST_COMMIT}" >> $GITHUB_OUTPUT
          echo "Last checked commit: ${LAST_COMMIT}"

      - name: Generate tracked files list
        if: steps.clone-upstream.outcome == 'success'
        id: tracked-files
        run: |
          ./utils/generate_tracked_files.sh \
            ddprof-lib/src/main/cpp \
            /tmp/async-profiler/src \
            > /tmp/tracked_files.txt

          echo "Tracking $(wc -l < /tmp/tracked_files.txt) files"
          cat /tmp/tracked_files.txt

      - name: Track upstream changes
        if: steps.clone-upstream.outcome == 'success'
        id: track-changes
        run: |
          ./utils/track_upstream_changes.sh \
            /tmp/async-profiler \
            "${{ steps.get-last-commit.outputs.last_commit }}" \
            "${{ env.UPSTREAM_HEAD }}" \
            /tmp/tracked_files.txt \
            /tmp/change_report.md \
            /tmp/change_report.json

          if [ -f /tmp/change_report.json ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected!"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Create GitHub Issue
        if: steps.track-changes.outputs.has_changes == 'true' && steps.clone-upstream.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ steps.octo-sts.outputs.token }}
        run: |
          # Verify report file exists before creating issue
          if [ ! -f /tmp/change_report.md ]; then
            echo "Error: Report file not found, skipping issue creation"
            exit 0
          fi

          ISSUE_TITLE="Upstream async-profiler changes detected ($(date +%Y-%m-%d))"

          gh issue create \
            --title "$ISSUE_TITLE" \
            --body-file /tmp/change_report.md \
            --label "upstream-tracking,needs-review" \
            --repo ${{ github.repository }}

      - name: Update last checked commit
        if: success() && steps.clone-upstream.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ steps.octo-sts.outputs.token }}
        run: |
          # Update state file with current commit
          STATE_FILE=".github/upstream-tracker-state.txt"
          echo "${UPSTREAM_HEAD}" > "$STATE_FILE"

          # Commit and push the state file
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$STATE_FILE"

          if git diff --staged --quiet; then
            echo "No changes to state file"
          else
            git commit -m "Update upstream tracker state to ${UPSTREAM_HEAD:0:7}

Automated commit by upstream-tracker workflow to persist last checked commit."
            git push origin main
            echo "Updated last checked commit to ${UPSTREAM_HEAD}"
          fi
